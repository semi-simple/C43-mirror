#!/bin/bash

pgm=$1
h=${2:-src/qspi_crc.h}

q=build/dmcp/${pgm}_qspi.bin

if [[ "$OSTYPE" == "darwin"* ]]; then
        # Host is Mac: use gstat for GNU version
        STAT=gstat
else
        # Assume host is Linux: stat is GNU version
        STAT=stat
fi



filesize() {
	$STAT -Lc%s "$1"
}


if [ ! -f "$q" ];then
	echo "ERROR: Missing qspi file '$q'"
	exit 1
fi

if [ ! -f "$h" ]; then
	sz=0
	crc=0
else
	sz=`cat $h  | grep SIZE | awk '{print $3}'`
	crc=`cat $h | grep CRC  | awk '{print $3}'`
fi

nsz=`filesize $q`
ncrc=0x`tools/crc32 $q`

# Don't 'fix' the CRC because a particular fixed CRC is needed by DMCP
#if [ $sz != $nsz -o $crc != $ncrc ]; then
if [ $sz != $nsz ]; then
#    CRC:   $crc	-> $ncrc
	cat << OI
====
QSPI Contents changed:
   Size:   $sz	-> $nsz
====
Run build once more.
OI
	cat << OI > $h

#define QSPI_DATA_SIZE $nsz
// Real QSPI_DATA_CRC: $ncrc
#define QSPI_DATA_CRC 0x000CFED6

OI
	exit 1
fi
